<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
        <link rel="stylesheet" href="../css/base.css" />
        <link rel="stylesheet" href="../css/base_modal.css" />
        <link rel="stylesheet" href="../css/auth_modal.css" />
    </head>
    <body>
        <div class="modal">
            <div class="modal__bg"></div>
            <main class="main">
                <button class="close-modal-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <img src="../assets/logo.png" alt="logo" class="logo" />
                <h1 class="main__title">Đăng nhập vào <span>HuanCanhCut</span></h1>
                <div class="main__content">
                    <form id="login-form">
                        <div class="form-group">
                            <input
                                type="text"
                                name="email"
                                id="email"
                                class="form-control"
                                placeholder="Nhập email của bạn"
                            />
                            <span class="form-message"></span>
                        </div>

                        <div class="form-group">
                            <input
                                type="password"
                                name="password"
                                id="password"
                                class="form-control"
                                placeholder="Nhập mật khẩu của bạn"
                            />
                            <span class="form-message"></span>
                        </div>

                        <span class="error-message"></span>

                        <button type="submit" class="form__button">Đăng nhập</button>
                    </form>
                    <div class="form__footer">
                        <p class="form__footer-toggle-text">
                            Bạn không có tài khoản?
                            <span class="form__footer-toggle form__footer-toggle--register">Đăng ký</span>
                        </p>
                        <p class="form__footer-forgot-password">Quên mật khẩu</p>
                        <p class="form__footer-policy">
                            Việc bạn tiếp tục sử dụng trang web này có nghĩa bạn đồng ý với điều khoản sử dụng của chúng
                            tôi
                        </p>
                    </div>
                </div>
            </main>
        </div>
    </body>

    <script src="../config/axiosClient.js" type="module"></script>
    <script src="../js/login_modal.js"></script>
    <script src="../js/base_modal.js"></script>
    <script src="../js/Validator.js"></script>
    <script type="module">
        import * as axiosClient from '../config/axiosClient.js'

        Validator({
            form: '#login-form',
            errorSelector: '.form-message',
            formGroup: '.form-group',
            rules: [
                Validator.isRequired('#email'),
                Validator.isEmail('#email'),
                Validator.isRequired('#password'),
                Validator.isPassword('#password', 6),
            ],
            submit: async (data) => {
                const { email, password } = data

                try {
                    const res = await axiosClient.post('/auth/login', { email, password })

                    window.parent.postMessage(
                        {
                            type: 'modal:auth-success',
                            data: { message: 'Đăng nhập thành công', currentUser: res.data.data },
                        },
                        '*'
                    )
                } catch (error) {
                    const errorMessage = document.querySelector('.error-message')

                    if (error.status === 401) {
                        errorMessage.textContent = 'Email hoặc mật khẩu không chính xác'
                    } else {
                        errorMessage.textContent = error.response.data.message
                    }
                }
            },
        })
    </script>
</html>
